/*
Code Name: HOME_Automation
Author: RoboSiddhi

âš  Warning

This project and its code are shared for learning and personal use only.  
Commercial use, redistribution, or selling (in any form) of this code or
project is not allowed without proper permission.  

                                                                                 .                 
              !^           .   ..   ..            
              ??^~~~^.      ....:....             
             :P5J?7?JY5.   ...^:::^..             
            .BG5JY75&JYG   ...^:::^..             
            .BBBP57?YYYG.   ....::::              
             :YBBGYJ??Y?   .  .^ YGGY.            
              :!BBBBY!:       .G??5BP^            
            ~GP5P5??77!7:    .^J55Y!              
           ^#57!7#5777!?57~:~77JG~                
           ?#G5PB#57777!B5GG5YPJ.                 
          .BGYY&&BPY???J!!Y5Y7:                   
          :7!~!7777!!!!^     
                               
Description: This project implements a sophisticated IoT-based home automation architecture capable of remote appliance management. Built upon the ESP32 framework with OLED 
visualization and relay actuation, the system utilizes a dedicated Android application to configure and control electrical loads via a cloud interface
Great for
learning robotics, DIY projects, and basic STEM applications.
*/
#include <WiFiManager.h> 
#include <Firebase_ESP_Client.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

// ==========================================
// 1. CONFIGURATION
// ==========================================
#define API_KEY "AIzaSyBRjV8NTMgp26Vj3TNTl51zqd_CywcGels" 
#define DATABASE_URL "https://iot-switch-628c3-default-rtdb.firebaseio.com/" 

// !!! CRITICAL: PASTE YOUR DATABASE SECRET HERE !!!
#define FIREBASE_SECRET "RcAlAbdxJaIGD1Kk8uZSgDrJVuiO8cxfk1WtzRkT"

// ==========================================
// 2. HARDWARE PINS
// ==========================================
#define RELAY_1 26
#define RELAY_2 27
#define BOOT_BUTTON 0

// ==========================================
// 3. OBJECTS
// ==========================================
Adafruit_SSD1306 display(128, 64, &Wire, -1);
WiFiManager wm;
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// ==========================================
// 4. LOGO BITMAP DATA
// ==========================================
const unsigned char myLogo [] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf6, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf9, 0x80, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf8, 0x3f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf1, 0xff, 0xff, 0xbf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xc8, 0x3f, 0xe0, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xc1, 0x8f, 0xc1, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x87, 0xe7, 0xc1, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x88, 0x33, 0xc1, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x80, 0x13, 0xc0, 0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x80, 0x13, 0xe0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x80, 0x33, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xc0, 0x47, 0xff, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xc0, 0x07, 0xff, 0x07, 0xff, 0xff, 0xf8, 0x8f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xe0, 0x01, 0xff, 0xa7, 0xff, 0xff, 0xfa, 0x2b, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0xff, 0xe7, 0xff, 0xff, 0xf8, 0x05, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xfc, 0x00, 0x1f, 0xcf, 0xff, 0xfe, 0x3a, 0x4b, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x1f, 0xff, 0xfe, 0xb8, 0x80, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x03, 0xff, 0xff, 0xfe, 0x30, 0x12, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x0f, 0xff, 0xff, 0xfe, 0x4f, 0x89, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x07, 0xff, 0xff, 0xfe, 0x1f, 0xc3, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xe0, 0x07, 0xf0, 0x7f, 0xff, 0xff, 0x3f, 0x8f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x80, 0x3f, 0xff, 0x1f, 0xff, 0xff, 0x1f, 0x1f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x02, 0x0f, 0xff, 0xc7, 0xff, 0xfe, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x0f, 0xc3, 0xff, 0xe1, 0xff, 0xf9, 0xe0, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x0f, 0xe1, 0xff, 0xf0, 0x7f, 0xe7, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x1f, 0xe1, 0xff, 0xfb, 0x3f, 0xcf, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x1f, 0xe0, 0xff, 0xf9, 0xcf, 0x3f, 0x87, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x0f, 0xe0, 0xff, 0xf9, 0xf2, 0x7f, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x07, 0xc1, 0xff, 0xf9, 0xf9, 0xfc, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfc, 0x00, 0x80, 0xff, 0xf8, 0x60, 0x38, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0xff, 0xf8, 0x07, 0x30, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0xff, 0xf8, 0x00, 0x81, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf8, 0x1e, 0x00, 0x7f, 0xf8, 0x00, 0x83, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf0, 0x3c, 0x00, 0x7f, 0xf3, 0x80, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf0, 0x38, 0x00, 0x3f, 0xf3, 0xf0, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf0, 0x78, 0x00, 0x1f, 0xf7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xfe, 0x07, 0xff, 0xf1, 0xff, 0xff, 0xf0, 0x71, 0xfe, 0x3f, 0xc6, 0x3f, 0x8f, 0xff, 0xff, 
  0xff, 0xfe, 0x01, 0xff, 0xf9, 0xff, 0xff, 0xc0, 0x31, 0xfe, 0x3f, 0xc6, 0x3f, 0xcf, 0xff, 0xff, 
  0xff, 0xfe, 0x71, 0xff, 0xf9, 0xff, 0xff, 0xc7, 0xff, 0xfe, 0x3f, 0xc6, 0x3f, 0xff, 0xff, 0xff, 
  0xff, 0xfe, 0x71, 0xe0, 0x79, 0x07, 0x81, 0xc7, 0xf1, 0xc0, 0x38, 0x06, 0x01, 0xcf, 0xff, 0xff, 
  0xff, 0xfe, 0x03, 0xc6, 0x38, 0xc6, 0x18, 0xe0, 0xf1, 0x8c, 0x31, 0x86, 0x31, 0xcf, 0xff, 0xff, 
  0xff, 0xfe, 0x07, 0x8f, 0x19, 0xe2, 0x3c, 0xf8, 0x31, 0x9e, 0x33, 0xc6, 0x38, 0xcf, 0xff, 0xff, 
  0xff, 0xfe, 0x63, 0x8f, 0x19, 0xe2, 0x3c, 0xfe, 0x31, 0x9e, 0x33, 0xc6, 0x38, 0xcf, 0xff, 0xff, 
  0xff, 0xfe, 0x71, 0xcf, 0x39, 0xc6, 0x38, 0xde, 0x31, 0x8e, 0x31, 0xc6, 0x38, 0xcf, 0xff, 0xff, 
  0xff, 0xfe, 0x78, 0xc0, 0x38, 0x07, 0x01, 0xc0, 0x31, 0x80, 0x30, 0x06, 0x38, 0xcf, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xf9, 0xff, 0xbf, 0xe7, 0xf1, 0xff, 0xe7, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

// ==========================================
// 5. STATE
// ==========================================
bool cloudConnected = false;
bool relay1State = false;
bool relay2State = false;

// ==========================================
// 6. HELPER FUNCTIONS
// ==========================================
void updateDisplay();
void drawSwitchIcon(int x, int y, bool state);
void checkPhysicalReset();
void configModeCallback(WiFiManager *myWiFiManager);

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  // --- HARDWARE ---
  pinMode(RELAY_1, OUTPUT);
  pinMode(RELAY_2, OUTPUT);
  pinMode(BOOT_BUTTON, INPUT_PULLUP);
  
  // FIX: Start LOW (OFF) instead of HIGH
  digitalWrite(RELAY_1, LOW); 
  digitalWrite(RELAY_2, LOW);

  // --- OLED INIT ---
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("OLED Failed");
  } else {
    // === SHOW STARTUP LOGO ===
    display.clearDisplay();
    display.drawBitmap(0, 0, myLogo, 128, 64, WHITE);
    display.display();
    delay(2000); 
    
    // Continue
    display.clearDisplay();
    display.setTextColor(WHITE);
    display.setTextSize(1);
    display.setCursor(0,0);
    display.println("System Booting...");
    display.display();
  }

  checkPhysicalReset();

  // --- WIFI ---
  wm.setDebugOutput(true);
  wm.setAPCallback(configModeCallback); 

  // Try to connect
  bool res = wm.autoConnect("ESP32-Setup"); 

  if(!res) {
    display.clearDisplay();
    display.setCursor(0,0); display.println("WiFi Failed!");
    display.display();
  } else {
    display.clearDisplay();
    display.setCursor(0,0); display.println("WiFi Connected!");
    display.println(WiFi.localIP());
    display.println(" ");
    display.println("Auth with Secret...");
    display.display();
  }

  // --- FIREBASE SETUP ---
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  // Master Key Auth
  config.signer.tokens.legacy_token = FIREBASE_SECRET;

  config.token_status_callback = tokenStatusCallback; 
  
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
}

void loop() {
  checkPhysicalReset();

  if (Firebase.ready()) {
    
    // Update screen once connected
    if (!cloudConnected) {
        cloudConnected = true;
        updateDisplay(); 
    }

    // --- RELAY 1 (FIXED LOGIC) ---
    if (Firebase.RTDB.getBool(&fbdo, "/home/relay1")) {
      bool target = fbdo.boolData();
      if (target != relay1State) {
        relay1State = target;
        // FIX: If target is TRUE (ON), write HIGH.
        digitalWrite(RELAY_1, relay1State ? HIGH : LOW);
        updateDisplay();
      }
    }

    // --- RELAY 2 (FIXED LOGIC) ---
    if (Firebase.RTDB.getBool(&fbdo, "/home/relay2")) {
      bool target = fbdo.boolData();
      if (target != relay2State) {
        relay2State = target;
        // FIX: If target is TRUE (ON), write HIGH.
        digitalWrite(RELAY_2, relay2State ? HIGH : LOW);
        updateDisplay();
      }
    }
    
    // --- RESET ---
    if (Firebase.RTDB.getBool(&fbdo, "/home/reset_wifi")) {
      if (fbdo.boolData()) {
        Firebase.RTDB.setBool(&fbdo, "/home/reset_wifi", false);
        display.clearDisplay();
        display.setCursor(0, 20); display.println("RESETTING...");
        display.display();
        wm.resetSettings();
        delay(1000);
        ESP.restart();
      }
    }

  } else {
    cloudConnected = false;
    static unsigned long lastErr = 0;
    if (millis() - lastErr > 2000) {
       lastErr = millis();
       Serial.print("Error: ");
       Serial.println(fbdo.errorReason());

       display.clearDisplay();
       display.setCursor(0, 0); 
       display.println("CLOUD ERROR:");
       display.println(fbdo.errorReason());
       display.display();
    }
  }
}

// ==========================================
// HELPERS
// ==========================================

void configModeCallback (WiFiManager *myWiFiManager) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.println("SETUP REQUIRED");
  display.drawLine(0, 10, 128, 10, WHITE);
  display.setCursor(0, 20);
  display.println("Connect to WiFi:");
  display.println("ESP32-Setup");
  display.display();
}

void checkPhysicalReset() {
  if (digitalRead(BOOT_BUTTON) == LOW) {
    unsigned long startPress = millis();
    while (digitalRead(BOOT_BUTTON) == LOW) {
      if (millis() - startPress > 3000) {
        display.clearDisplay();
        display.setCursor(0, 20); display.println("ERASING WIFI...");
        display.display();
        wm.resetSettings();
        delay(1000);
        ESP.restart();
      }
    }
  }
}

void updateDisplay() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(20, 0); display.println("SYSTEM ONLINE");
  display.drawLine(0, 10, 128, 10, WHITE);

  display.setCursor(0, 25); display.print("R1");
  drawSwitchIcon(30, 20, relay1State);

  display.setCursor(65, 25); display.print("R2");
  drawSwitchIcon(95, 20, relay2State);
  display.display();
}

void drawSwitchIcon(int x, int y, bool state) {
  display.drawRoundRect(x, y, 30, 15, 7, WHITE);
  if (state) {
    display.fillCircle(x + 22, y + 7, 5, WHITE);
  } else {
    display.drawCircle(x + 7, y + 7, 5, WHITE);
  }
}